package it.smartcommunitylab.gamification.log_converter;

import java.io.File;
import java.io.IOException;
import java.net.URISyntaxException;

import org.junit.Assert;
import org.junit.Test;

import com.google.common.base.Charsets;
import com.google.common.io.Files;

import it.smartcommunitylab.gamification.log_converter.beans.Record;
import it.smartcommunitylab.gamification.log_converter.beans.RecordType;
import it.smartcommunitylab.gamification.log_converter.manager.RecordManager;

public class RecordManagerTest {

	@Test
	public void testAction() throws IOException, URISyntaxException {
		RecordManager recordManager = new RecordManager();

		String recordInput = Files.asCharSource(
				new File(Thread.currentThread().getContextClassLoader().getResource("action-record-input").toURI()),
				Charsets.UTF_8).read();
		String recordOutput = Files.asCharSource(
				new File(Thread.currentThread().getContextClassLoader().getResource("action-record-output").toURI()),
				Charsets.UTF_8).read();

		Record record = new Record();
		record.setType(RecordType.ACTION);
		record.setContent(recordInput);
		record.setIndexType(recordInput.indexOf("type=Action"));
		String result = recordManager.trasformaFormatoAction(record);
		Assert.assertEquals(recordOutput, result);
	}

	@Test
	public void testPointConcept() {
		RecordManager recordManager = new RecordManager();

		String recordContent = "INFO - \"57ac710fd4c6ac7872b0e7a1\" \"24371\" 006d06ae-04f8-42ba-88f8-b12ccb617326 1477124848884 1477124848898 type=Action action=\"save_itinerary\" payload=\"{\"walkDistance\":1.2106966311267948}\" oldState=\"[{\"id\":\"1\",\"name\":\"public transport aficionado\",\"badgeEarned\":[\"5_pt_trip\",\"10_pt_trip\"]},{\"name\":\"w6_recommendation_1_2c71c3cb-063c-41ff-a715-ef16f148215a\",\"modelName\":\"absoluteIncrement\",\"fields\":{\"bonusScore\":250.0,\"periodName\":\"weekly\",\"bonusPointType\":\"green leaves\",\"counterName\":\"Recommendations\",\"target\":1.0},\"start\":1476482400000,\"end\":1477087200000,\"completed\":false},{\"id\":\"1\",\"name\":\"leaderboard top 3\",\"badgeEarned\":[]},{\"name\":\"w3_no_car_3_e5fcffa5-1b1b-4283-b969-a4ce476b1336\",\"modelName\":\"absoluteIncrement\",\"fields\":{\"bonusScore\":100.0,\"periodName\":\"weekly\",\"bonusPointType\":\"green leaves\",\"counterName\":\"NoCar_Trips\",\"target\":3.0},\"start\":1474668000000,\"end\":1475272800000,\"completed\":true,\"dateCompleted\":1475140073856},{\"id\":\"1\",\"name\":\"BikeSharing_Km\",\"score\":0.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[]}}},{\"id\":\"1\",\"name\":\"green leaves\",\"score\":2383.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":467.0,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":718.0,\"start\":1475272800000,\"end\":1475877600000,\"index\":4},{\"score\":1116.0,\"start\":1475877600000,\"end\":1476482400000,\"index\":5},{\"score\":82.0,\"start\":1476482400000,\"end\":1477087200000,\"index\":6}]}}},{\"id\":\"1\",\"name\":\"bike sharing pioneer\",\"badgeEarned\":[]},{\"id\":\"1\",\"name\":\"Walk_Trips\",\"score\":53.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":8.0,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":18.0,\"start\":1475272800000,\"end\":1475877600000,\"index\":4},{\"score\":24.0,\"start\":1475877600000,\"end\":1476482400000,\"index\":5},{\"score\":3.0,\"start\":1476482400000,\"end\":1477087200000,\"index\":6}]}}},{\"name\":\"w6_bus_trips_6_d2b82d92-c0f8-4258-bf52-8858644fe432\",\"modelName\":\"absoluteIncrement\",\"fields\":{\"bonusScore\":200.0,\"periodName\":\"weekly\",\"bonusPointType\":\"green leaves\",\"counterName\":\"Bus_Trips\",\"target\":6.0},\"start\":1476482400000,\"end\":1477087200000,\"completed\":false},{\"id\":\"1\",\"name\":\"BikeSharing_Trips\",\"score\":0.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":0.0,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":0.0,\"start\":1475272800000,\"end\":1475877600000,\"index\":4}]}}},{\"name\":\"w5_green_leaves_300_5ca5255a-8012-4100-9f44-6d09d43c2a60\",\"modelName\":\"absoluteIncrement\",\"fields\":{\"bonusScore\":300.0,\"periodName\":\"weekly\",\"bonusPointType\":\"green leaves\",\"counterName\":\"green leaves\",\"target\":300.0},\"start\":1475877600000,\"end\":1476482400000,\"completed\":true,\"dateCompleted\":1476168869151},{\"id\":\"1\",\"name\":\"Car_Trips\",\"score\":0.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[]}}},{\"id\":\"1\",\"name\":\"recommendations\",\"badgeEarned\":[]},{\"id\":\"1\",\"name\":\"Car_Km\",\"score\":0.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[]}}},{\"id\":\"1\",\"name\":\"Train_Trips\",\"score\":12.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":0.0,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":4.0,\"start\":1475272800000,\"end\":1475877600000,\"index\":4},{\"score\":7.0,\"start\":1475877600000,\"end\":1476482400000,\"index\":5},{\"score\":1.0,\"start\":1476482400000,\"end\":1477087200000,\"index\":6}]}}},{\"name\":\"w2_walk_percent_30_88a1a5e6-8823-4137-b9f2-45e041b15e0a\",\"modelName\":\"percentageIncrement\",\"fields\":{\"bonusScore\":150.0,\"periodName\":\"weekly\",\"bonusPointType\":\"green leaves\",\"baseline\":19.8561493870331,\"counterName\":\"Walk_Km\",\"target\":26.0},\"start\":1475877600000,\"end\":1476482400000,\"completed\":true,\"dateCompleted\":1476474017546},{\"name\":\"w7_no_car_25_f0366735-fe88-4034-a839-f62ccd430c6f\",\"modelName\":\"absoluteIncrement\",\"fields\":{\"bonusScore\":200.0,\"periodName\":\"weekly\",\"bonusPointType\":\"green leaves\",\"counterName\":\"NoCar_Trips\",\"target\":25.0},\"start\":1477087200000,\"end\":1477692000000,\"completed\":false},{\"id\":\"1\",\"name\":\"Bike_Km\",\"score\":23.4331333764905,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":8.09119406592581,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":15.3419393105647,\"start\":1475272800000,\"end\":1475877600000,\"index\":4}]}}},{\"id\":\"1\",\"name\":\"Transit_Trips\",\"score\":0.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[]}}},{\"id\":\"1\",\"name\":\"bike aficionado\",\"badgeEarned\":[\"1_bike_trip\",\"5_bike_trip\",\"10_bike_trip\"]},{\"id\":\"1\",\"name\":\"green leaves\",\"badgeEarned\":[\"50_point_green\",\"100_point_green\",\"200_point_green\",\"400_point_green\",\"800_point_green\",\"1500_point_green\"]},{\"id\":\"1\",\"name\":\"Bus_Trips\",\"score\":11.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":2.0,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":1.0,\"start\":1475272800000,\"end\":1475877600000,\"index\":4},{\"score\":6.0,\"start\":1475877600000,\"end\":1476482400000,\"index\":5},{\"score\":2.0,\"start\":1476482400000,\"end\":1477087200000,\"index\":6}]}}},{\"id\":\"1\",\"name\":\"park and ride pioneer\",\"badgeEarned\":[]},{\"id\":\"1\",\"name\":\"Recommendations\",\"score\":0.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":0.0,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":0.0,\"start\":1475272800000,\"end\":1475877600000,\"index\":4},{\"score\":0.0,\"start\":1475877600000,\"end\":1476482400000,\"index\":5},{\"score\":0.0,\"start\":1476482400000,\"end\":1477087200000,\"index\":6}]}}},{\"id\":\"1\",\"name\":\"ZeroImpact_Trips\",\"score\":46.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":11.0,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":19.0,\"start\":1475272800000,\"end\":1475877600000,\"index\":4},{\"score\":14.0,\"start\":1475877600000,\"end\":1476482400000,\"index\":5},{\"score\":2.0,\"start\":1476482400000,\"end\":1477087200000,\"index\":6}]}}},{\"id\":\"1\",\"name\":\"Walk_Km\",\"score\":63.369205481093516,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":11.648024649404,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":19.8561493870331,\"start\":1475272800000,\"end\":1475877600000,\"index\":4},{\"score\":29.3042503191188,\"start\":1475877600000,\"end\":1476482400000,\"index\":5},{\"score\":2.5607811255376167,\"start\":1476482400000,\"end\":1477087200000,\"index\":6}]}}},{\"id\":\"1\",\"name\":\"Train_Km\",\"score\":174.215831190915,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":0.0,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":56.6034328468407,\"start\":1475272800000,\"end\":1475877600000,\"index\":4},{\"score\":99.0560074819713,\"start\":1475877600000,\"end\":1476482400000,\"index\":5},{\"score\":18.5563908621027,\"start\":1476482400000,\"end\":1477087200000,\"index\":6}]}}},{\"name\":\"w4_bike_KMpercent_50_e319e0c8-79e8-4170-9f23-18b5683bb008\",\"modelName\":\"percentageIncrement\",\"fields\":{\"bonusScore\":200.0,\"periodName\":\"weekly\",\"bonusPointType\":\"green leaves\",\"baseline\":6.05626390428399,\"counterName\":\"Bike_Km\",\"target\":9.0},\"start\":1475272800000,\"end\":1475877600000,\"completed\":true,\"dateCompleted\":1475428570232},{\"name\":\"w4_bike_sharing_try_1_b99de4b8-8ef6-46ff-9068-d865bdb9fc38\",\"modelName\":\"absoluteIncrement\",\"fields\":{\"bonusScore\":200.0,\"periodName\":\"weekly\",\"bonusPointType\":\"green leaves\",\"counterName\":\"BikeSharing_Trips\",\"target\":1.0},\"start\":1475272800000,\"end\":1475877600000,\"completed\":false},{\"id\":\"1\",\"name\":\"sustainable life\",\"badgeEarned\":[\"1_zero_impact_trip\",\"5_zero_impact_trip\",\"10_zero_impact_trip\",\"25_zero_impact_trip\"]},{\"id\":\"1\",\"name\":\"PandR_Trips\",\"score\":0.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[]}}},{\"id\":\"1\",\"name\":\"NoCar_Trips\",\"score\":68.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":13.0,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":24.0,\"start\":1475272800000,\"end\":1475877600000,\"index\":4},{\"score\":27.0,\"start\":1475877600000,\"end\":1476482400000,\"index\":5},{\"score\":4.0,\"start\":1476482400000,\"end\":1477087200000,\"index\":6}]}}},{\"name\":\"w7_green_leaves_400_c6eb7404-37a9-4a73-8b58-25ddf552b777\",\"modelName\":\"absoluteIncrement\",\"fields\":{\"bonusScore\":300.0,\"periodName\":\"weekly\",\"bonusPointType\":\"green leaves\",\"counterName\":\"green leaves\",\"target\":400.0},\"start\":1477087200000,\"end\":1477692000000,\"completed\":false},{\"name\":\"w3_green_leaves_200_8ab1ecdf-d8da-4d50-ab12-21b55097c077\",\"modelName\":\"absoluteIncrement\",\"fields\":{\"bonusScore\":120.0,\"periodName\":\"weekly\",\"bonusPointType\":\"green leaves\",\"counterName\":\"green leaves\",\"target\":200.0},\"start\":1474668000000,\"end\":1475272800000,\"completed\":true,\"dateCompleted\":1475163388128},{\"id\":\"1\",\"name\":\"Bike_Trips\",\"score\":11.0,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":5.0,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":6.0,\"start\":1475272800000,\"end\":1475877600000,\"index\":4}]}}},{\"id\":\"1\",\"name\":\"Bus_Km\",\"score\":38.0745404410919,\"periods\":{\"weekly\":{\"start\":1472853600000,\"period\":604800000,\"identifier\":\"weekly\",\"instances\":[{\"score\":0.0,\"start\":1472853600000,\"end\":1473458400000,\"index\":0},{\"score\":0.0,\"start\":1473458400000,\"end\":1474063200000,\"index\":1},{\"score\":0.0,\"start\":1474063200000,\"end\":1474668000000,\"index\":2},{\"score\":5.93730349030604,\"start\":1474668000000,\"end\":1475272800000,\"index\":3},{\"score\":2.71366478049934,\"start\":1475272800000,\"end\":1475877600000,\"index\":4},{\"score\":20.1847391674807,\"start\":1475877600000,\"end\":1476482400000,\"index\":5},{\"score\":9.23883300280587,\"start\":1476482400000,\"end\":1477087200000,\"index\":6}]}}}]\"";
		Record record = new Record();
		record.setType(RecordType.ACTION);
		record.setContent(recordContent);
		record.setIndexType(recordContent.indexOf("type=Action"));
		String result = recordManager.trasformaFormatoAction(record);
	}

	@Test
	public void testBadgeCollection() {
		RecordManager recordManager = new RecordManager();

		String recordContent = "INFO - \"57ac710fd4c6ac7872b0e7a1\" \"24340\" 4ec61032-b3eb-48d0-bd92-3bd51c71250c 1477087206137 1477087209605 type=BadgeCollectionConcept ruleName=\"1st of the week\" name=\"leaderboard top 3\" badges=\"[2nd_of_the_week, 1st_of_the_week]\"";
		Record record = new Record();
		record.setType(RecordType.RULE_BADGECOLLECTIONCONCEPT);
		record.setContent(recordContent);
		record.setIndexType(recordContent.indexOf("type=BadgeCollectionConcept"));
		String result = recordManager.trasformaFormatoBadgeCollection(record);
	}
}
